name: CI - EchoInStone Execution Modes

on:
  push:
    branches: [ main, feature/* ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      test_url:
        description: 'Test URL for audio processing'
        required: false
        default: 'https://www.youtube.com/watch?v=plZRCMx_Jd8'

jobs:
  test-cli-mode:
    name: Test CLI Mode
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install poetry
        poetry install
    
    - name: Run CLI tests
      run: |
        poetry run pytest tests/ -v
    
    - name: Test CLI execution with sample audio
      run: |
        poetry run python main.py "tests/resources/sample_speech.wav" --output_dir test_output
      continue-on-error: true

  test-serverless-mode:
    name: Test Serverless Mode
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install poetry
        poetry install
    
    - name: Test Lambda handler
      run: |
        cd serverless
        poetry run python handler.py
      continue-on-error: true
    
    - name: Test Kubernetes handler functionality
      run: |
        poetry run python -c "
        import sys
        import os
        sys.path.append('.')
        from serverless.handler import kubernetes_handler
        
        test_data = {
            'echo_input': 'tests/resources/sample_speech.wav',
            'output_dir': 'test_results'
        }
        
        print('Testing Kubernetes handler...')
        result = kubernetes_handler(test_data)
        print(f'Result status: {result.get(\"status\", \"unknown\")}')
        "
      continue-on-error: true

  test-web-mode:
    name: Test Web Server Mode
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install poetry
        poetry install
    
    - name: Test Flask web handler
      run: |
        poetry run python -c "
        import sys
        import os
        sys.path.append('.')
        from serverless.handler import http_handler
        
        print('Testing Flask web handler initialization...')
        app = http_handler()
        print('Flask app created successfully')
        
        # Test health endpoint
        with app.test_client() as client:
            response = client.get('/health')
            print(f'Health check status: {response.status_code}')
            print(f'Health check response: {response.get_json()}')
        "

  run-bdd-tests:
    name: Run BDD Tests
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install poetry
        poetry install
    
    - name: Run BDD tests (excluding YouTube tests in CI)
      run: |
        poetry run pytest features/ -v --tb=short -k "not (test_successful_youtube_download or test_valid_transcription_output)"
      continue-on-error: true

  integration-test:
    name: Integration Test All Modes
    runs-on: ubuntu-latest
    needs: [test-cli-mode, test-serverless-mode, test-web-mode]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install poetry
        poetry install
    
    - name: Run integration tests
      run: |
        poetry run pytest tests/test_integration.py -v
    
    - name: Upload test artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results
        path: |
          test_output/
          results/
          test_results/
        retention-days: 7